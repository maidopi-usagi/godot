# Godot ReSTIR GI å®æ–½è¿›åº¦è·Ÿè¸ª

## é¡¹ç›®æ¦‚è¿°
åœ¨Godot 4å¼•æ“ä¸­å®ç°åŸºäºReSTIRæ··åˆè¿½è¸ªçš„é«˜ç²¾åº¦å…¨å±€å…‰ç…§ç³»ç»Ÿã€‚
**é‡å¤§æ¶æ„è°ƒæ•´ (2025-12-03)**: æ”¾å¼ƒä½¿ç”¨Godotå†…ç½®SDFGIä½œä¸ºä¸–ç•Œç©ºé—´æ•°æ®æºã€‚è½¬è€Œå‚è€ƒUnity HTrace WSGIï¼Œå®ç°è‡ªå®šä¹‰çš„**åŸºäºå…‰æ …åŒ–çš„ä½“ç´ åŒ– (Rasterization-based Voxelization)** ç³»ç»Ÿï¼Œä»¥è·å¾—å¯¹æ•°æ®ç»“æ„å’Œæ›´æ–°ç­–ç•¥çš„å®Œå…¨æ§åˆ¶ã€‚

## å®Œæˆçš„å·¥ä½œ

### ç¬¬ä¸€é˜¶æ®µ: æ¶æ„è®¾è®¡ä¸æ ¸å¿ƒç»“æ„ (éƒ¨åˆ†é‡æ„) ğŸ”„

#### 1.1 åŸºç¡€æ¶æ„ âœ…
- **æ–‡ä»¶**: `servers/rendering/renderer_rd/environment/restir_gi.h`
- **æ–‡ä»¶**: `servers/rendering/renderer_rd/environment/restir_gi.cpp`
- **çŠ¶æ€**: å·²å»ºç«‹åŸºç¡€ç±»ç»“æ„ï¼Œä½†éœ€è¦ç§»é™¤SDFGIç›¸å…³ä¾èµ–ï¼Œæ·»åŠ Voxelizerç›¸å…³æ¥å£ã€‚

#### 1.2 GBufferç³»ç»Ÿ âœ…
- **æ–‡ä»¶**: `servers/rendering/renderer_rd/shaders/environment/restir_gbuffer.glsl`
- **çŠ¶æ€**: å®Œæˆã€‚GBufferç”Ÿæˆä¸ä½“ç´ åŒ–æ— å…³ï¼Œå¯ç›´æ¥å¤ç”¨ã€‚

#### 1.3 å…‰çº¿ç”ŸæˆShader âœ…
- **æ–‡ä»¶**: `servers/rendering/renderer_rd/shaders/environment/restir_ray_gen.glsl`
- **çŠ¶æ€**: å®Œæˆã€‚

#### 1.4 å±å¹•ç©ºé—´è¿½è¸ªShader âœ…
- **æ–‡ä»¶**: `servers/rendering/renderer_rd/shaders/environment/restir_screen_trace.glsl`
- **çŠ¶æ€**: å®Œæˆã€‚

## å¾…å®æ–½ä»»åŠ¡ (é‡æ„è·¯çº¿å›¾)

### æ–°Â·ç¬¬ä¸‰é˜¶æ®µ: è‡ªå®šä¹‰ä½“ç´ åŒ–ç³»ç»Ÿ (Voxelization) ğŸš§
**ç›®æ ‡**: å®ç°ä¸€å¥—åŸºäºClipmap (Cascades) çš„ä½“ç´ åŒ–ç®¡çº¿ï¼Œæ›¿ä»£SDFGIã€‚

- [ ] **3.1 ä½“ç´ æ•°æ®ç»“æ„è®¾è®¡**
  - å®šä¹‰ Clipmap ç»“æ„ (ç±»ä¼¼ HTrace/VXGI)ã€‚
  - çº¹ç†æ ¼å¼è§„åˆ’:
    - `VoxelAlbedo`: R32_UINT (RGBA8 Packed) æˆ– R16G16B16A16_FLOAT
    - `VoxelNormal`: R32_UINT (Octahedral Packed)
    - `VoxelEmissive`: R32_UINT (Shared with Albedo?)
  - æ˜¾å­˜ç®¡ç†ç­–ç•¥ã€‚

- [ ] **3.2 ä½“ç´ åŒ– Shader å®ç°**
  - **Vertex Shader**: å¤„ç†é¡¶ç‚¹å˜æ¢ï¼Œæ”¯æŒ GPU Instancingã€‚
  - **Geometry Shader**: å®ç° "Dominant Axis Selection" (ä¸‰è½´æŠ•å½±)ï¼Œç¡®ä¿ä½“ç´ åŒ–æ— ç©ºæ´ã€‚
  - **Fragment Shader**: ä½¿ç”¨ `imageAtomic` æˆ– `Interlocked` æ“ä½œå†™å…¥ 3D çº¹ç†ã€‚
  - å‚è€ƒ: `VoxelizationStages.hlsl`ã€‚

- [ ] **3.3 ä½“ç´ åŒ–ç®¡çº¿é›†æˆ (C++)**
  - åˆ›å»º `Voxelizer` ç±»ã€‚
  - æ³¨å…¥ Godot æ¸²æŸ“å¾ªç¯ï¼šéœ€è¦éå†åœºæ™¯ä¸­çš„ MeshInstanceï¼Œæäº¤ç»˜åˆ¶å‘½ä»¤åˆ°ä½“ç´ åŒ– Framebufferã€‚
  - å®ç° Clipmap æ›´æ–°é€»è¾‘ (Center Snapping, Scrolling)ã€‚

### æ–°Â·ç¬¬å››é˜¶æ®µ: ä¸–ç•Œç©ºé—´è¿½è¸ª (é‡å†™) ğŸš§
**ç›®æ ‡**: åºŸå¼ƒ SDF Sphere Tracingï¼Œæ”¹ç”¨ Voxel DDA æˆ– Cone Tracingã€‚

- [ ] **4.1 ç§»æ¤/é‡å†™ `restir_world_trace.glsl`**
  - ç§»é™¤æ‰€æœ‰ SDFGI é‡‡æ ·ä»£ç ã€‚
  - å®ç° `TraceVoxel` å‡½æ•°ï¼š
    - åœ¨ Clipmap çº§è”ä¹‹é—´éå†ã€‚
    - ç¡¬ä»¶ä¸‰çº¿æ€§æ’å€¼ vs æ‰‹åŠ¨ DDA æ­¥è¿›ã€‚
  - è§£å†³æ¼å…‰å’Œè‡ªé®æŒ¡é—®é¢˜ã€‚

### ç¬¬äº”é˜¶æ®µ: è¾å°„åº¦ç¼“å­˜ç³»ç»Ÿ (é€‚é…) ğŸ”„
- [x] 5.1 å“ˆå¸Œè¡¨ç»“æ„ (å·²å®Œæˆï¼Œéœ€é€‚é…æ–°å…‰ç…§)
- [ ] 5.2 ç¼“å­˜æ›´æ–° Shader
  - éœ€è¦ä½¿ç”¨æ–°çš„ä½“ç´ æ•°æ®æ¥è®¡ç®—ç¼“å­˜ç‚¹çš„åˆå§‹è¾å°„åº¦ã€‚

### ç¬¬å…­é˜¶æ®µ: ReSTIRé‡‡æ ·å®ç° (é€‚é…) ğŸ”„
- [x] 5.1 æ—¶é—´é‡é‡‡æ · (å·²å®Œæˆ)
- [x] 5.2 ç©ºé—´é‡é‡‡æ · (å·²å®Œæˆ)
- [ ] **é€‚é…å·¥ä½œ**: ç¡®ä¿é‡‡æ ·å™¨èƒ½æ­£ç¡®è¯»å–æ–°çš„ä¸–ç•Œç©ºé—´è¾å°„åº¦ã€‚

### ç¬¬ä¸ƒé˜¶æ®µ: é™å™ªä¸åˆæˆ
- [ ] 6.1 æ—¶ç©ºé™å™ªå™¨
- [ ] 6.2 æœ€ç»ˆåˆæˆ

## åºŸå¼ƒ/æ—§è®¡åˆ’å½’æ¡£
- ~~3.1 SDFGIæ•°æ®å¤ç”¨ç ”ç©¶~~ (å·²åºŸå¼ƒ: ç²¾åº¦ä¸è¶³ï¼Œä¸å¯æ§)
- ~~3.2 åŸºäºSDFçš„Sphere Tracing~~ (å·²åºŸå¼ƒ: æ›¿æ¢ä¸ºä½“ç´ è¿½è¸ª)

## æŠ€æœ¯æŒ‘æˆ˜ (æ–°)

### 1. Godot æ¸²æŸ“ç®¡çº¿æ³¨å…¥
**æŒ‘æˆ˜**: å¦‚ä½•åœ¨ä¸ä¿®æ”¹ Godot æ ¸å¿ƒ (`RenderingServer`) å¤ªå¤šçš„æƒ…å†µä¸‹ï¼Œé«˜æ•ˆåœ°æŠŠåœºæ™¯å†ç”»ä¸€éï¼ˆä½“ç´ åŒ–ï¼‰ï¼Ÿ
**æ–¹æ¡ˆ**: 
- å¯èƒ½éœ€è¦åˆ©ç”¨ `RenderSceneExtension` æˆ–åœ¨ `render_forward_clustered.cpp` ä¸­æ‰‹åŠ¨æ’å…¥ä¸€ä¸ª Passã€‚
- éœ€è¦è®¿é—® `RenderGeometryInstance` åˆ—è¡¨ã€‚

### 2. å‡ ä½•ç€è‰²å™¨æ€§èƒ½
**æŒ‘æˆ˜**: Geometry Shader åœ¨æŸäº›ç¡¬ä»¶ä¸Šæ€§èƒ½ä¸ä½³ã€‚
**æ–¹æ¡ˆ**: 
- ä¼˜å…ˆä½¿ç”¨ GS å®ç°ï¼ˆç®€å•ï¼‰ã€‚
- å¤‡é€‰æ–¹æ¡ˆï¼šä½¿ç”¨ Compute Shader è¿›è¡Œä¸‰è§’å½¢å…‰æ …åŒ–ï¼ˆè½¯ä»¶å…‰æ …åŒ–ï¼‰ï¼Œæˆ–è€…ä½¿ç”¨å¤šè§†å£/å¤šé‡å®ä¾‹åŒ–æŠ€æœ¯ã€‚

### 3. åŠ¨æ€ç‰©ä½“æ›´æ–°
**æŒ‘æˆ˜**: æ¯ä¸€å¸§é‡æ–°ä½“ç´ åŒ–æ•´ä¸ªåœºæ™¯å¤ªæ…¢ã€‚
**æ–¹æ¡ˆ**: 
- é™æ€ç‰©ä½“ï¼šåªåœ¨ Clipmap æ»šåŠ¨æ—¶æ›´æ–°ã€‚
- åŠ¨æ€ç‰©ä½“ï¼šæ¯å¸§æ¸…é™¤å¹¶é‡æ–°ä½“ç´ åŒ–åˆ°å¯¹åº”çš„åŒºåŸŸã€‚

## å‚è€ƒèµ„æ–™æ›´æ–°
- **Unity HTrace**: `VoxelizationStages.hlsl` (æ ¸å¿ƒå‚è€ƒ)
- **NVIDIA VXGI**: çº§è”ä½“ç´ åŒ–åŸç†ã€‚
- **Godot Source**: `rasterizer_scene_gles3.cpp` (æŸ¥çœ‹å¦‚ä½•æäº¤ç»˜åˆ¶å‘½ä»¤)

---
**æœ€åæ›´æ–°**: 2025-12-03
**å½“å‰çŠ¶æ€**: æ­£åœ¨è¿›è¡Œæ¶æ„é‡æ„ï¼Œä» SDFGI åˆ‡æ¢åˆ°è‡ªå®šä¹‰ä½“ç´ åŒ–ã€‚

